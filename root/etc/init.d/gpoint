#!/bin/sh /etc/rc.common
# Copyright 2021-2025 Vladislav Kadulin {spanky@yandex.ru}

USE_PROCD=1
START=95
STOP=01

CONFIGURATION=gpoint

start_service() {
    config_load "${CONFIGURATION}"
    procd_open_instance
    procd_append_param command /usr/share/gpoint/gpoint
    procd_set_param respawn
    procd_set_param stdout 1
    procd_set_param stderr 1
    procd_set_param pidfile /var/run/gpoint.pid
    procd_close_instance
    echo "gpoint service start"
}

stop_service() {
    sessionId=$(uci get gpoint.service_settings.sessionid 2>/dev/null || echo "")
    if [ -n "$sessionId" ] && [ "$sessionId" != "stop" ]; then
        ubus call session destroy "{\"ubus_rpc_session\":\"${sessionId}\"}" 2>/dev/null || true
        uci set gpoint.service_settings.sessionid=stop
        uci commit gpoint 2>/dev/null || true
    fi

    PID=""
    if [ -f /var/run/gpoint.pid ]; then
        PID=$(cat /var/run/gpoint.pid 2>/dev/null || echo "")
    fi
    
    if [ -n "$PID" ] && kill -0 "$PID" 2>/dev/null; then
        timeout=5
        count=0
        while kill -0 "$PID" 2>/dev/null && [ $count -lt $timeout ]; do
            sleep 1
            count=$((count + 1))
        done

        if kill -0 "$PID" 2>/dev/null; then
            kill -9 "$PID" 2>/dev/null || true
            sleep 1
        fi
    fi

    /usr/share/gpoint/gpoint stop >/dev/null 2>&1 || true
    echo "gpoint service stop"
}
